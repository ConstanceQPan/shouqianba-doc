# Upay WAP支付开发者文档

对于具有一定开发能力的商户，可以通过对接Upay支付网关来支持[WAP支付](#wap)，让顾客可以直接在商户的网页上进行移动支付，从而拓展商户的线上业务渠道。

目前Upay WAP支付仅支持 **微信** 一种支付通道，对于其他支付通道的支持会陆续开放。

## 1. 业务场景

顾客在支付客户端（如微信）中访问商户的商城页面，选择商品后结账，触发支付控件（如点击支付按钮），支付客户端会弹出支付控件提示用户输入支付密码，用户输入密码后完成支付，商户页面提示交易进行中，在商户获取到支付结果后，在页面上展示支付结果和订单信息。

## 2. 业务流程

![image](http://images.wosaimg.com/88/05f978ea0bb0a3c719aebc735764aa5bf478aa.png "收钱吧WAP支付流程")

#### 流程介绍

1. 用户访问商户的移动端支付页面，触发支付控件（如点击支付按钮）。
2. 支付页面的前端逻辑验证支付参数后，向商户的后端服务器发起创建订单请求。
3. 商户后端服务器收到请求后再次验证请求参数，向收钱吧服务器发起预下单请求。
4. 收钱吧服务器确认请求有效后，向指定的支付渠道发起预下单交易流程。
5. 支付渠道同步返回预下单结果。
6. 收钱吧服务器将订单信息和预下单结果返回给商户后端服务器。
7. 商户后端服务器将预下单结果返回给自己的前端页面（其中包含唤起支付客户端支付控件所需的支付参数）。与此同时，商户后端服务器开始轮询收钱吧服务器该订单的支付状态。<span style="color:red; font-weight: bold;">*</span>
8. 商户前端页面利用返回结果中的支付参数唤起客户端支付控件。<span style="color:red; font-weight: bold;">**</span>
9. 用户输入密码，确认支付。
10. 商户前端页面收到客户端前端Javascript SDK的回调，开始展示支付进行中的页面。与此同时，前端页面向商户后端服务器发起查询请求（建议使用长连接），等待最终支付结果的返回。
11. 商户后端服务器收到前端页面的查询请求，则保持该连接直至从收钱吧服务器查询到最终支付结果。
12. 商户后端服务器返回最终支付结果，前端页面展示支付成功页面和订单信息。

<span style="color:red; font-weight: bold;">*</span>：目前Upay支付网关暂不支持异步回调通知，因此需要商户后端服务器进行轮询获取最新订单支付状态。

<span style="color:red; font-weight: bold;">**</span>：在前端页面中唤起微信支付控件需要调用微信的前端支付接口，请确保您在开发前充分了解[微信WAP支付](https://pay.weixin.qq.com/wiki/doc/api/wap.php?chapter=15_1)的相关业务流程和前端开发接口

13. 在对接WAP支付接口前，请先联系我们的销售人员填写服务商申请资料和商户入网资料，商户入网资料中填写地微信相关参数必与开发者公众号保持一致。

## 3. 接口说明

### 3.1 预下单

#### 3.1.1 接口地址

    {api_domain}/upay/v2/precreate

#### 3.1.2 请求参数

具体请参考收钱吧支付网关[支付类API Reference](https://wosai.gitbooks.io/shouqianba-doc/content/api/core.html)

#### 3.1.3 特别说明

- 目前预下单接口的WAP支付请求暂时只支持微信)支付。
- 对于WAP支付请求，请求参数中的`sub_payway`的值必须为`"3"`，`payer_uid`为**必填**，取值为商户公众号下该用户的open_id；
- 对于WAP支付请求，返回结果中的`wap_pay_request`包含了商户支付的前端页面需要唤起微信支付控件所需的必要参数。

### 3.2 查询

#### 3.2.1 接口地址

    {api_domain}/upay/v2/query

#### 3.2.2 请求参数

具体请参考收钱吧支付网关[支付类API Reference](https://wosai.gitbooks.io/shouqianba-doc/content/api/core.html)

#### 3.2.3 特别说明

- 商户后端服务器在得到预下单成功的结果后，即可向收钱吧服务器发起轮询请求。
- 收钱吧目前所有预下单的订单有效支付时长约为90秒，若超时仍未支付，收钱吧会自动取消该订单；因此轮询时间请控制在**100-120秒**左右。
- 轮询的间隔建议为**前30秒内2秒一次，之后5秒一次**。


## 4. 名词解释

**WAP支付：**<a name="wap"></a> 顾客通过支付客户端访问商家页面直接进行移动支付的支付方式。

## 5. 版本记录

<table>
    <thead style="font-weight: bold;">
        <tr>
            <td>版本</td>
            <td style="min-width:110px">日期</td>
            <td>说明</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>0.1.0</td>
            <td>2016年03月08日</td>
            <td>提交审阅</td>
        </tr>
        <tr>
            <td>1.0.0</td>
            <td>2016年03月09日</td>
            <td>正式发布</td>
        </tr>
    </tbody>
</table>

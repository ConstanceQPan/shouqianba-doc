#名词解释
**服务商/vendor：**接入收钱吧支付平台Web API 或 SDK 的开发者

**服务商序列号/vendor_sn:**服务商序列号

**服务商密钥/vendor_key:**服务商密钥

**激活码/code:**终端激活码，用于激活终端，获取终端号和终端密钥。

**终端/terminal:**指实际进行交易的媒介系统，可以为实体收银机系统、智能设备里的APP、线上网页（e.g. 线上购物、会员充值等）

**终端号/terminal_sn:**终端序列号

**终端密钥/terminal_key:**终端密钥

#收钱吧支持场景
`收款通道：指微信/支付宝/QQ/京东/百度等钱包对应的支付通道，下文中均使用“各种钱包”替代说明`

**B扫C:**消费者展示各种钱包内的“刷卡条码/二维码”给商户系统扫描后直接完成支付的模式。主要应用线下面对面收银的场景。

**C扫B:**商户系统按想着各种钱包对应的支付协议（输入金额）生成支付二维码，消费者再用各种钱包“扫一扫”完成支付的模式。该模式适用于PC网站支付、实体店单品或订单支付、媒体广告支付等场景。

**WAP支付:**

- **公众号WAP:**公众号支付是用户在微信中打开商户的H5页面，商户在H5页面通过调用微信支付提供的JSAPI接口调起微信支付模块完成支付。

	--用户在微信公众账号内进入商家公众号，打开某个主页面，完成支付

	--用户的好友在朋友圈、聊天窗口等分享商家页面连接，用户点击链接打开商家页面，完成支付

- **门店码WAP:**

	--将商户页面转换成二维码，贴在门店里，消费者扫描二维码后在各种钱包浏览器中打开页面后，输入金额并完成支付


#收钱吧支持的渠道
- 支付宝
- 微信
- 百付宝
- 京东钱包
- QQ钱包（即将上线）

#收钱吧支持的接入方式
- Web API
- SDK

#收钱吧支持的对接模式

##系统对接
在商户没有终端的情况下，直接在服务器管理终端号和终端密钥。商户前端只与商户后端通信，后端服务器发现是某个前端的支付请求，就将这笔交易对应到收钱吧的终端，利用这个终断的terminal_sn和terminal_key向收钱吧服务端发起请求。


收钱吧所有交易都需要终端号和终端密钥。开发者可以选择所有支付都算作一个终端发起的请求，也可以采用“前端1->收钱吧终端1，前端2->收钱吧终端2”的方式。后者的好处在于便于商户日后在`商户系统`中对账。

#网络限制

终端不能直接与外网通信

**解决方案(Windows SDK):**增加代理设置就是在KeyParams文件中增加如下两行：

	Proxy:http-proxy-sha.corporate.ge.com

	ProxyPort:80
	
参考[收钱吧支付网关2.0-windowsSDK开发接入文档](https://github.com/WoSai/shouqianba-doc/blob/master/zh-cn/sdk/windows.md)“4.5.1 KeyParams” 

注释掉则不生效
##收钱吧服务器IP
域名：https://api.shouqianba.com

端口：443
##什么是收钱吧终端？
指实际进行交易的媒介系统，可以为实体收银机系统、智能设备里的APP、线上网页（e.g. 线上购物、会员充值等）

每个门店下都允许存在多个终端。
##激活码使用说明
每一个激活码都有可激活次数限制，可激活次数=门店终端数量。

同一个激活码，每调用一次激活接口，可激活次数就减一，当可激活次数为0，激活码将失效。


##激活码是否可作为固定的参数存储起来？
不可以!激活码是与门店相对应的，每一个激活码都有可激活次数限制。将激活码作为固定参数存储很容易发生激活码失效等问题。

另外，共用激活码不便于商户日后在[商户系统](http://s.shouqianba.com/#/order)中对账。


##激活码是不是每一台终端都需要一个？
不是。激活码是与门店相对应的，每个门店需要一个激活码，每个激活码可激活次数=门店终端数量。

同一个激活码每次调用激活接口，返回的终端号和终端密钥是不一样的。
##如果在日后的维护过程中客户电脑损坏重装以后，怎么能够快速激活？有没有好的解决方案？
如果设备损坏了，但是设备硬盘还是可以使用的，那么原来的激活的程序可以拷贝出来继续使用。只有当激活文件被损坏了或者与终端不匹配了才需要重新激活码。



##是否能用SDK2.0直接覆盖SDK1.0使用？
不能！SDK1.0与SDK2.0是完全不同的对接模式。SDK1.0是从商户维度接入，SDK2.0是从终端维度接入，从1.0升级到2.0，需要重新编写程序。

**注意：**

1.新SDK升级以后，授权机制有变动，之前的ID和KEY不能通用；

2.Windows SDK2.0调用支付类接口不需要类似pay等前缀。


##调用接口传入信息有没有加密校验？
有的。

**签名算法**

采用应用层签名机制。将HTTP请求body部分的UTF-8编码字节流视为被签名的内容，不关心主体的格式。

签名人序列号（sn）和签名值（sign）放在HTTP请求头中，在接入服务中统一校验。

签名算法: sign = MD5( CONCAT( body + key ) )

签名首部: Authorization: sn + " " + sign

**签名所用的sn和key**

激活接口（/terminal/activate）的签名使用服务商序列号（vendor_sn）和（vendor_key）

其他接口均使用激活接口成功返回的终端号（terminal_sn）和终端密钥（terminal_key）


##激活接口的作用
收钱吧所有交易都需要终端号和终端密钥。

激活终端是为了拿到交易接口签名需要的参数（终端号和终端密钥），激活完一台终端，开发者需要把终端号和终端密钥信息持久化保持，以后每日签到更新终端密钥。

不管是支付（B扫C）还是预下单（C扫B）都需要激活后才能调用。

	一个终端只需激活一次，之后调用支付类接口（不论支付还是预下单）都不需要再激活。
	
	不需要每次进入程序时都调用激活函数。
	
	收钱吧不对同一个终断的激活次数做限制，开发者需要自行判断终端是否已激活。
	
	服务商参数vendor_sn和vendor_key是不变的，建议写死在程序里，以后直接输入激活码激活终端。
	

##签到接口的作用
一个密钥每个自然日会过期。签到的作用是更新终端密钥，获取每日最新密钥。开发者需要把最新的terminal_key保存下来。

	SDK 会自动完成签到，不需要单独签到。
	Web API 建议每自然天执行第一笔核心支付接口调用时，自动执行签到操作。
	
##签到后secret丢失怎么办？
若因网络或其他原因未收到签到响应，可使用旧密钥再次发起签到请求。

极特殊情况下，两次签到均未收到响应，请联系客服处理。


##device_id是什么？
设备指纹device_id唯一标识一台设备的编号，如Android设备的IMEI，IOS设备的identifierForVendor。

##client_sn是什么？
client_sn：商户系统订单号，必须在商户系统内唯一。
##支付失败后重新进行支付可以延用之前的client_sn吗？
不能。

一笔交易中，前台订单号是唯一的，例如0001，提交支付失败后，再次提交支付请求，订单号就不能是0001了。


##通讯响应码说明
200：通讯成功；400：客户端错误；500:服务端错误

error_code为本次通讯的错误码，error_message为对应的中文描述。当result_code不等于200的时候才会出现error_code和error_message。

result_code:400，客户端错误。客户端请求错误。INVALID_PARAMS/参数错误；INVALID_TERMINAL/终端错误；ILLEGAL_SIGN/签名错误。

result_code:500，服务端错误。收钱吧服务端异常。可提示“服务端异常，请联系收钱吧客服”。

##业务结果码（biz_response.result_code）说明
biz_response.result_code是业务响应码，biz_response.result_code返回SUCCESS表示业务执行成功，具体到业务场景会返回不同业务员结果码。

PAY_SUCCESS：支付操作成功。

PAY_FAIL：支付操作失败并且已冲正。`下一步操作：重新进行一笔交易。`

PAY_FAIL_ERROR：支付操作失败并且不确定第三方支付通道状态。`下一步操作：调用查询接口发起轮询，确定订单最终状态。`

CANCEL_SUCCESS：撤单操作成功。

CANCEL_ERROR：撤单操作失败并且不确定第三方支付通道状态。`下一步操作：调用查询接口发起轮询，确定订单最终状态。`

CANCEL_ABORT_ERROR：撤单操作试图终止进行中的支付流程，但是失败，不确定第三方支付通道的状态。`下一步操作：调用查询接口查询，确定订单最终状态。`

CANCEL_ABORT_SUCCESS：撤单操作试图终止进行中的支付流程并且成功。

REFUND_SUCCESS：退款操作成功。

REFUND_ERROR：退款操作失败并且不确定第三方支付通状态。`下一步操作：调用查询接口查询，确定订单最终状态。`

PRECREATE_SUCCESS：预下单操作成功。发起轮询

PRECREATE_FAIL：预下单操作失败。`下一步操作：重新进行一笔交易。`

SUCCESS：查询操作成功。**开发者根据返回的biz_response.data.order_status属性判断当前收钱吧订单的状态。**

FAIL：查询操作失败。

##订单状态（biz_response.data.order_status）说明
**开发者根据返回的biz_response.data.order_status属性判断当前收钱吧订单的状态。**

CREATED：订单已创建/支付中。

PAID：订单支付成功。

PAY_CANCELED：支付失败并且已经成功充正。

PAY_ERROR：支付失败，不确定是否已经成功充正。
REFUNDED：已成功全额退款。

PARTIAL_REFUNDED：已成功部分退款。

REFUND_ERROR：退款失败并且不确定第三方支付通道的最终退款状态。
CANCELED：客户端发起的撤单已成功。

CANCEL_ERROR：客户端发起的撤单失败并且不确定第三方支付通道的最终状态。
##何时发起轮询

1. pay接口何时发起轮询：如果pay同步返回的order_status不是最终状态，就需要马上发起轮询。轮询时间可以在3~5s，总时长控制在40~50s左右。

	pay接口返回：biz_response.result_code是指一个动作的状态。biz_response.data罗列订单信息，biz_response.data.order_status是指订单状态。


2. precreate接口何时发起轮询：

	Web API接入：客户扫了二维码之后，建议马上发起轮询，轮询时间可以在3~5s。
	
	SDK接入：如果是有UI模式，SDK会查询预支付结果，不需要额外写程序查询，如果是无UI模式，则需要轮询支付结果。


		C扫B模式生成的二维码有两种：
		第一种是没有有效期的。长期使用的二维码可以用wap支付实现
		第二种是有有效期的。precreate接口生成的二维码的有效期：4min
		
##哪些状态是订单最终状态
- PAID
- PAY_CANCELED
- REFUNDED
- PARTIAL_REFUNDED
- CANCELED

##何时调用撤单接口(cancel)？
客户端发起支付请求以后没有收到结果或订单不是最终状态，且在有效时间内也轮询订单依然不是最终状态，则发起自动撤单。该动作类似于POS机的冲正。

##每次支付失败都需要调用撤单接口(cancel)吗？
只有在规定时间内轮询得到的订单状态不为最终状态才需要自动冲正。
##手动撤单和自动撤单有什么区别？
手动撤单和自动撤单的区别只是撤单目的不同，实际执行的业务逻辑是完全一样的。

##撤单和退款有什么区别？
退款接口，不限制退款次数，可操作至剩余金额为0。退款成功后，手续费按照退款金额占订单金额比例系数乘以订单总手续费进行手续费退还。

撤单接口，一笔订单只能在当天进行一次撤单，撤单的时候是全额退款，包括支付手续费。进行过退款的订单不能撤单。

##手动撤单可以在订单支付完成后多久以内可以提交请求？
过了当天无法撤单。
##退款可以在订单支付完成后多久以内可以提交请求？
退款没有时间限制。

##C扫B的模式，二维码可以不依赖终端生成吗？
可以。可采用`系统对接`方式实现。



##支付成功后支付宝、微信显示信息分别是什么？
支付时需要传入商品名称，这个一方面是保留业务信息，另一方面是会展示在消费者的付款终端上。

支付成功后，微信APP上，商品信息显示的是商品名称。

##Windows SDK如何判断此机是否曾经激活过？
Windows SDK有个获取终端号接口terminalSN()，如果未激活的话设备编号是空的，可以通过这个接口判断是否已激活。

##Windows SDK，不同的订单，第一张订单还没被扫的情况下能不能继续生成第二张订单的二维码？
preCreateUI不可以，preCreateUI需要得到第一张订单支付结果之后才能继续生成第二张订单。
preCreate可以。

##Windows SDK业务的请求地址（接入域名）是写死在dll里的吗？可以换成内网IP吗？
业务请求地址不是写死的。可以通过KeyParams文件配置 SDK 的基本参数。AppURL:后面跟需要的地址，以/结束。参考[收钱吧支付网关2.0-windowsSDK开发接入文档](https://github.com/WoSai/shouqianba-doc/blob/master/zh-cn/sdk/windows.md)“4.5.1 KeyParams” 

##关于Window SDK时序
Windows SDK对于业务时序都是封装好的，不需要用户自己查询和撤单，SDK自动完成。SDK调用的结果只有成功和失败。（preCreate除外）

##Windows SDK特殊字符
所有的参数,不能含有特殊字符，除 extended 参数外的所有参数中包含”字符的,需要使用\”转义代替。

##Windows SDK调用接口返回值是乱码？
Windows SDK统一采用 UTF-8 字符编码

设置自动编码autoCodec(1),只需调用一次

先调用version接口,获取SDK版本测试字符串返回接收的代码是否正确

##Windows SDK保存二维码图片可以自定义名称吗？
可以的。

Windows SDK接入二维码名称后面会跟一个qrcode。

##Windows SDK最低支持的系统版本
Windows SDK 最低支持 XP

##异常业务如何测试
网络超时可以用网络调试工具模拟

业务不成功可以故意不支付或者借记卡内余额不足实现

一些小概率事件，如业务端返回500，难以模拟，那么修改下判断条件，覆盖想测试的代码路径确定控制逻辑正确即可。


##支付宝是不是采用的2.0协议？
是的，采用支付宝当面付2.0接口协议。


##是否支持官方优惠金额和商户优惠金额的回传？
支付完成之后，收钱吧会返回订单原始金额，消费者支付金额和商家实收金额（Windows SDK暂不支持）

商户折扣=total_amount-paid_amount

如果没有退款，net_amount=total_amount

##用户的付款是直接到我的账户，还是由收钱吧托管？
如果拥有各支付渠道的账户，则付款直接到对应的账户里，否则由收钱吧托管。






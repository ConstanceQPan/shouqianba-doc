# 万能收银台back-end接口文档

标签 : 收钱吧

###概述
 **1.接口功能描述**

    本接口是喔噻万能收银台提供给 第三方合作方的前置代理接口
    喔噻会为
    	1）使用本系统的第三方商户分配： wosai_store_id,wosai_appid,wosai_appkey,其中，wosai_appkey为私钥，必须在商户系统中妥善保存，不得外泄；
    	2）使用本系统的合作方分配： channel_id; channel_secret;其中channel_secret为合作方私钥，必须妥善保存，不得外泄。由channel_secret外泄造成的损失第三方自行承担
    	
   `系统中涉及到的人民币交易金额都要以 分 为单位；比如：交易金额为1元，则total_fee=100`
   
   
   
   
 **2.签名方式描述**
    	
  `第三方合作厂商在调用收钱吧提供的接口的过程中，必须传输的三个基本数据： wosai_store_id,wosai_app_id, channel_id ; 同时所有的请求都需要用channel_secret进行签名`
   
   1）域名
   	
   	（开发联调过程中先用开发环境域名，开发完成，通过收钱吧验收以后才分配生产环境相关合法参数）
   		
   		开发环境： https://api.dev.shouqianba.com
   		

   		生产环境： https://api.shouqianba.com
   			
   	
   2)  签名算法：
   	 
   	  ①生成待签名字符串
   	   非空请求参数带着 wosai_store_id,wosai_app_id,wosai_appkey,channel_id,channel_secret 按照key进行ascii排序；
   	   
   	   ②按照k1=34&k2=34&k3=sd的顺序拼接成字符串； 
   	   
   	   ③把字符串MD5以后，转换为大写
   	   
   	   
   3）签名字符串生成示例：
     
     ```
     e.g: 
      假设调用支付接口的时候 有8个参数： 
      total_fee=1;
      subject=test;
      operator  = hyx;
      remark = buy
      wosai_store_id = 12;
      wosai_appid = 23;
      wosai_appkey = xxdsfs;
      channel_id = 23;
      channel_secret = keel;
   
      ascii排序后得到拼接字符串： $str = channel_id=23&channel_secret=keel&operator=hyx&remark=buy&subject=test&total_fee=1&wosai_appid=23&wosai_appkey=xxdsfs&wosai_store_id=23
  
      将该字符串md5加密后转为大写： $sign=strToUpper(md5($str));

 	 则最终调用支付接口的时候需要传递的参数为：
      wosai_store_id;
      wosai_appid;
      channel_id
      total_fee
      subject
      remark
      operator
      sign 
      
     ``` 
   	   



**3.系统返回值描述**

```
系统返回值均为标准的json格式字符串，
其中包含三个主要字段： code,msg,data;

code 返回码：为10000的时候表示通讯成功，code不为10000的时候，错误信息会在msg字段中；
msg:错误信息，当code不等于10000的时候，出错信息会在此字段中

data:系统返回数据，比如商户信息，支付结果等等
```



###1.微信支付-公众号支付下单

**url**

    API_DOMAIN/Upay/weixinWapPay


**参数**
   参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
sign|签名字符串|Y
wechat_app_id|商户的公众号appid|Y
open_id|上一参数传微信公众号下的openId|Y
subject|商品描述，UTF-8编码，128汉字|Y
total_fee|商品价格，以分位单位| Y
store_owner_order_sn| 商户自己系统中的唯一订单号| Y
detail | 商品名称明细列表 | N 
notify_url|接受服务器异步通知的地址|Y
client_ip|发起支付请求的客户端ip|Y


**返回值**

```
{
    "data": [],
    "code": "10000",
    "msg": "succ"
}
```	


**返回结果**

```
{
	"data": {
    	"order_sn": "FC1426326908", // 收钱吧系统订单
    	"store_owner_order_sn": "20150314175508", // 商户订单
    	"ctime": "2015-11-07 17:55:10",
    	"order_detail": "testWeixinWapPay",
    	"status": 0, // 订单状态，不为 1 时订单未成功
    	"order_pay_detail": {
    	    "return_code": "SUCCESS",
    	    "return_msg": "OK",
    	    "result_code": "SUCCESS",
    	    "trade_type": "JSAPI",
    	    "app_id": "wx8888888888888888", // 商户在喔噻系统预留的公众号的 appId，用于在微信浏览器调起支付控件
    	    "time_stamp": "1414561699", // 参与签名的时间戳，用于在微信浏览器调起支付控件
    	    "nonce_str": "5K8264ILTKCH16CQ2502SI8ZNMTM67VS", // 参与签名的随机字符串，用于在微信浏览器调起支付控件
	        "prepay_id": "123456789" // 微信预支付交易会话标识用于在微信客户端发起支付
	        "sign_type": "MD5", // 签名方式，用于在微信浏览器调起支付控件
	        "pay_sign": "C380BEC2BFD727A4B6845133519F3AD6" // 签名，用于在微信浏览器调起支付控件
	    },
	    "pay_way": "WEIXIN",
	    "sub_pay_way": "WAPYPAY",
    	"total_fee": "1",
    	"wosai_store_id": "03322111001200200000024",
    	"is_liquidation_next_day": 1
	},
	"code": "10000",
	"msg": "succ"
}
```

###2. 微信支付-退款
  
 **url**
  
    API_DOMAIN/Upay/weixinRefund
 
 **参数**
 
   参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
 sign|签名字符串|Y
wosai_order_sn | 收钱吧生成的订单号  | Y
refund_fee|退款金额，以分为单位，不得大于总金额|Y

**返回值**

```
{
    "data": [],
    "code": "10000",
    "msg": "succ"
}
```	

###3. 微信支付-订单查询

**url**
    api_domain/Upay/queryOrder
    
**参数**

   参数名 | 参数解释 | 是否必须
------------ | ------------- | ------------
 wosai_store_id | 喔噻商户ID  |  Y
wosai_app_id | 喔噻分配的appid  | Y
channel_id|代理商ID| Y
 sign|签名字符串|Y
wosai_order_sn | 收钱吧生成的订单号  | Y

**返回值**
```
{
    "data": {
        "id": "870",
        "order_sn": "EC31976100061965",
        "operator": "商户操作员",
        "wosai_store_id": "03322111001200200000009",
        "status": "0",
        "ctime": "2014-12-31 11:46:50",
        "last_modified": "2014-12-31 11:46:50",
        "order_pay_detail": "
        <xml>
           <return_code><![CDATA[SUCCESS]]></return_code>
           <return_msg><![CDATA[OK]]></return_msg>
           <appid><![CDATA[wx2421b1c4370ec43b]]></appid>
           <mch_id><![CDATA[10000100]]></mch_id>
           <nonce_str><![CDATA[NfsMFbUFpdbEhPXP]]></nonce_str>
           <sign><![CDATA[B7274EB9F8925EB93100DD2085FA56C0]]></sign>
           <result_code><![CDATA[SUCCESS]]></result_code>
           <transaction_id><![CDATA[1008450740201411110005820873]]></transaction_id>
           <out_trade_no><![CDATA[1415757673]]></out_trade_no>
           <out_refund_no><![CDATA[1415701182]]></out_refund_no>
           <refund_id><![CDATA[2008450740201411110000174436]]></refund_id>
           <refund_channel><![CDATA[]]></refund_channel>
           <refund_fee>1</refund_fee>
           <coupon_refund_fee>0</coupon_refund_fee>
        </xml>",
        "order_detail": "null",
        "remark": "",
        "pay_way": "ALIPAY",
        "total_fee": 100000,
        "store_owner_order_sn": "1",
        "notify_url": null,
        "buyer_account": "",
        "third_part_order_id": ""
    },
    "code": "10000",
    "msg": "succ"
}
```


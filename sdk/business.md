# <a name="workflow"></a> 业务流程
## 1.1 激活
### 业务场景
商户打开集成了SDK的应用，在发起任意交易前，需要使用收钱吧提供的设备激活码激活设备，否则执行交易会提示设备未激活。
### 交易流程
![](http://images.wosaimg.com/f7/087eb02fc4a3b19ea913606310a5eb42e24aee.png "支付交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写收钱吧设备激活码，请求激活。应用会将创建SDK任务，传入激活码，执行激活动作。
2. SDK验证激活码，验证无误后，将激活信息传给收钱吧服务器。
3. 收钱吧服务器会验证激活请求参数，验证无误后处理激活请求，并同步返回激活结果。
4. SDK对激活结果进行处理，并保存设备激活信息。
5. SDK将最终结果返回给操作员使用的应用，应用展示激活结果。
## 1.2 支付
### 业务场景
商户打开集成了SDK的应用，输入订单信息，扫描顾客手机中支付应用的付款条码，即可进行交易。待用户确认支付，商户便可获知收款结果。
### 交易流程
![](http://images.wosaimg.com/1c/1266eab5b5fabed2f612c56a8768b379e1799b.png "支付交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写订单相关信息，开启收款。收款设备打开扫码页面，操作员扫描顾客手机支付应用中的收款码。应用会将创建SDK任务，传入需支付的订单信息，执行支付动作。
2. SDK验证订单信息，验证订单信息无误后，将订单信息传给收钱吧服务器。
3. 收钱吧服务器会验证交易请求参数，验证无误后生成收钱吧订单，并向支付渠道发起交易请求。
4. 若交易渠道无需顾客提供交易密码，则会收钱吧服务器会立即返回交易结果；若需要顾客提供交易密码，则需等待顾客在手机支付应用中输入密码后，服务器才会返回交易结果；若顾客超时仍未输入密码，则视为放弃支付，直接取消交易。
5. 服务器将最终的交易结果连同订单信息一并返回给SDK。
6. SDK对支付结果和订单信息进行处理，将最终结果返回给操作员使用的应用，应用展示交易结果。

## 1.3 退款
### 业务场景
顾客提出退货要求，商户操作员根据订单号对某笔订单进行全额或部分退款。
### 交易流程
![](http://images.wosaimg.com/05/68da94304c804297e1927576044d62ab4959c1.png "退款交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写需要退款的订单号（收钱吧订单号或商户订单号）及退款金额。应用会将创建SDK任务，传入需退款的订单信息，执行退款动作。
2. SDK验证退款信息，验证无误后，将退款信息传给收钱吧服务器。
3. 收钱吧服务器再次验证退款请求参数，验证无误后，向支付渠道发起退款请求。
4. 支付渠道会将退款结果返回给收钱吧服务器。
5. 服务器将退款结果连同最新的订单信息一并返回给SDK。
6. SDK对退款结果和订单信息进行处理，将最终结果返回给操作员使用的应用，应用展示退款结果。
## 1.4 查询
### 业务场景
商户希望对某笔订单进行查询，获取订单详细信息，并确认当前订单的支付或退款状态。
### 交易流程
![](http://images.wosaimg.com/fb/9b3232e1f11e3f78c3e6a5b94d47f0d2c41c9d.png "查询交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写需要查询的订单号（收钱吧订单号或商户订单号）。应用会将创建SDK任务，传入需查询的订单信息，执行查询动作。
2. SDK验证查询请求，验证无误后，将查询请求传给收钱吧服务器。
3. 收钱吧服务器再次验证查询请求，验证无误后，查询当前订单状态，并将查询到的订单信息返回给SDK。收钱吧服务器会保证当前订单状态与支付渠道订单状态的同步。
4. SDK将查询结果返回给操作员使用的应用，应用展示查询结果。
## 1.5 预下单
### 业务场景
商户打开集成了SDK的应用，输入订单信息，进行预下单操作，此时应用会展示收款二维码，顾客只需打开手机中支付应用扫描收款码，即可进行交易。待用户确认支付，商户便可获知收款结果。
### 交易流程
![](http://images.wosaimg.com/89/6fbef38ffb9a62e920363c8816c00aa4452ecc.png "预下单交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写订单相关信息，开启预下单。应用会将创建SDK任务，传入需预下单的订单信息，执行预下单动作。
2. SDK验证订单信息，验证订单信息无误后，将订单信息传给收钱吧服务器。
3. 收钱吧服务器会验证交易请求参数，验证无误后生成收钱吧订单，并向支付渠道发起预下单请求。
4. 交易渠道将预下单结果返回给收钱吧服务器，收钱吧服务器将结果返回给SDK。
5. 根据返回的预下单结果，由SDK或操作员使用的应用展示收款二维码。
6. 顾客使用手机支付应用扫描收款码进行支付。
7. SDK会自动向收钱吧服务器发起查询请求，与此同时收钱吧服务器会向支付渠道查询支付结果。
8. 查询到最终交易结果后，收钱吧服务器将结果返回给SDK。SDK将最终支付结果返回给操作员使用的应用，应用展示最终交易结果。

## 1.6 撤单
### 业务场景
对于已成功支付或支付失败的订单，操作员希望取消交易时，可进行撤单操作*（已退款或已部分退款的订单无法进行撤单操作）*。收钱吧会对已成功支付的订单进行全额退款。
### 交易流程
![](http://images.wosaimg.com/2a/9f3bd2dcca05cd58e5fd5f3953853333006388.png "撤单交易流程")

### 流程介绍

1. 商户操作员使用集成了SDK的应用，填写需要撤单的订单号（收钱吧订单号或商户订单号）。应用会将创建SDK任务，传入需撤单的订单信息，执行撤单动作。
2. SDK验证撤单信息，验证无误后，将撤单信息传给收钱吧服务器。
3. 收钱吧服务器再次验证撤单请求参数，验证无误后，向支付渠道发起撤单请求。
4. 支付渠道会将撤单结果返回给收钱吧服务器。
5. 服务器将撤单结果连同最新的订单信息一并返回给SDK。
6. SDK对撤单结果和订单信息进行处理，将最终结果返回给操作员使用的应用，应用展示撤单结果。
